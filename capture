#imports
from picamera import PiCamera
import random
import RPi.GPIO as GPIO
import time
from io import BytesIO
import numpy as np
import concurrent.futures

#setting the gpio pin of the mouse and the specs of the "camera"
camera = PiCamera()
camera.resolution = (864, 480)
camera.framerate = 50
camera.zoom = (0.49,0.48,0.02,0.04)
time.sleep(2)

#setting up the led for registering clicks
GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)
GPIO.setup(18,GPIO.OUT)
GPIO.output(18,GPIO.HIGH)

#camera.start_preview()

#the function which scans an image for purple
def scan(image):
    # Checking for the right colors
    conditionColors = np.any((image[..., 0] > 219) & (np.logical_and(image[..., 1] > 54, image[..., 1] < 128)) & (image[..., 2] > 172))
    return conditionColors
    

#All hail chatgpt for making this asynchronous
#Also I won't have a job in a few years so please stop being smart
with concurrent.futures.ThreadPoolExecutor() as executor:
    stream = BytesIO()
    for _ in camera.capture_continuous(stream, format='rgb', use_video_port=True):
        stream.seek(0)
        image = np.frombuffer(stream.getvalue(), dtype=np.uint8)
        image = image.reshape((480, 864, 3))
        if scan(image):
            print("click")
            GPIO.output(18, GPIO.LOW)
            time.sleep(0.06 * random.random())
            GPIO.output(18, GPIO.HIGH)
            time.sleep(0.08 * random.random())
        stream.seek(0)
        stream.truncate()
